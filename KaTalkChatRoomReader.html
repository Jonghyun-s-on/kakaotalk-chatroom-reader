<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KakaoTalk Reader</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <style>
  </style>
</head>

<body>
  <div class="container mt-3">
    <div class="input-group mb-3">
      <input type="file" class="form-control" id="inputFile" aria-describedby="inputFileAddon" aria-label="Upload"
        accept=".txt">
    </div>
    <div id="title" class="mb-3"></div>
    <div id="filter" class="row">
      <div class="col-4">
        <input id="keyword" placeholder="Input your keyword." class="form-control mb-3" name="keyword" type="text">
      </div>
      <div class="col-2">
        <button type="button" class="btn btn-outline-primary" onclick="applyFilter()">search</button>
      </div>
    </div>
    <div id="total-count" class="mb-1"></div>
    <div id="content"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
  <script type="text/javascript">
    let bubbles = new Object()

    let proxy = new Proxy({ totalCount: 0 }, {
      set(target, property, value, receiver) {
        const titleElement = document.querySelector('#total-count')
        titleElement.innerText = 'Total Count: ' + value
      }
    })

    // 정규식
    const REGEX_BUBBLE = /^(?<date>\d{4}년 \d{1,2}월 \d{1,2}일) (?<time>\S{2} \d{1,2}:\d{1,2}), (?<name>\S+) : (?<content>.*)/
    const REGEX_KEY = /^(?<date>\d{4}년 \d{1,2}월 \d{1,2}일) (?<time>\S{2} \d{1,2}:\d{1,2})/
    const REGEX_DATE = /^(?<year>\d{4}년) (?<month>\d{1,2}월) (?<day>\d{1,2}일)/

    // file 선택 시 실행
    document.querySelector('#inputFile').onchange = function () {
      const file = this.files[0]
      const reader = new FileReader()
      reader.readAsText(file)
      reader.onload = function () {
        const fileContentArray = getFileContent(reader)
        if (fileContentArray.length > 0) {
          const title = fileContentArray.shift()
          const savedDate = fileContentArray.shift()
          bubbles = createbubbles(fileContentArray)

          renderTitle(title, savedDate)
          renderContent(bubbles)
        }
      }
    }

    const getFileContent = (reader) => {
      return reader.result.split('\r\n')
    }

    // 대화 데이터 생성
    const createbubbles = (contents) => {
      let bubs = new Object()
      let curIndex = new Number()
      let curDateKey = new String()
      for (let content of contents) {
        if (content !== '') {
          let match = content.match(REGEX_BUBBLE)
          if (match) {
            bubs[curDateKey].push({
              time: match.groups.time,
              name: match.groups.name,
              content: match.groups.content,
            })
            ++curIndex
          } else {
            let match = content.match(REGEX_KEY)
            if (match) {
              curIndex = 0
              curDateKey = formatDate(match.groups.date)
              bubs[curDateKey] = new Array()
            } else {
              let preContent = bubs[curDateKey][curIndex - 1].content
              bubs[curDateKey][curIndex - 1].content = preContent + '\n' + content
            }
          }
        }
      }
      return bubs
    }

    // 날짜 포멧팅 (yyyy-mm-dd)
    const formatDate = (koDate) => {
      let match = koDate.match(REGEX_DATE)
      if (match) {
        let year = match.groups.year.replace('년', '')
        let month = match.groups.month.replace('월', '')
        let day = match.groups.day.replace('일', '')
        if (Number(month) < 10) {
          month = '0' + month
        }
        if (Number(day) < 10) {
          day = '0' + day
        }
        return year + '-' + month + '-' + day
      } else {
        console.log("ERROR!")
      }
    }

    // 타이틀 렌더링
    const renderTitle = (title, savedDate) => {
      const titleElement = document.querySelector('#title')
      titleElement.replaceChildren()

      let hElement = document.createElement('h6')
      hElement.innerText = title + '\n' + savedDate
      titleElement.append(hElement)
    }

    // 컨텐트 렌더링
    const renderContent = (bubs, keyword = '') => {
      const contentElement = document.querySelector('#content')
      contentElement.replaceChildren()

      let totalCount = 0
      let renderingFlag = false

      for (let key in bubs) {
        renderingFlag = false
        let divElement1 = document.createElement('div')
        divElement1.className = "bubble-box"
        divElement1.innerText = key
        for (let bub of bubs[key]) {
          let divElement2 = document.createElement('div')

          if (String(bub.content).includes(keyword)) {
            divElement2.innerText = bub.name + ' ' + bub.time + ' : ' + bub.content
            divElement1.append(divElement2)
            renderingFlag = !renderingFlag ? true : false
            totalCount++
          }
        }
        if (renderingFlag) {
          contentElement.append(divElement1)
        }
      }
      proxy.totalCount = totalCount
    }

    // search 버튼 클릭 시 실행
    const applyFilter = () => {
      if (Object.keys(bubbles).length > 0) {
        const keyword = document.querySelector('#keyword').value
        renderContent(bubbles, keyword)
      } else {
        alert('No data for searching!')
      }
    }

  </script>
</body>

</html>